<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Edit User</title>
    <script src="jquery.js"></script>
</head>
<body onload="callLoadUser()">

    Name/Login <input type="text" name="name" id="name" size="10">
    <br/>
    Type <select name="type" id="type">
        <option value="Publisher">Publisher</option>
        <option value="Subscriber">Subscriber</option>
        <option value="Publisher-Subscriber">Publisher-Subscriber</option>
        <option value="Admin">Admin</option>
</select>
    <br/>
    Description <input type="text" name="description" id="description" size="20">
    <br/>
    Public Key <button onclick="generateKeyPair()">Generate</button>
    <input type="file" name="publicKeyfile" id="publicKeyfile" onchange="loadPublicKeyfile()">
    <br/>
    <textarea name="publicKey" id="publicKey" rows="10" cols="80"></textarea>
<br/>
    <button onclick="update()">Update</button>
</body>
</html>
<script>
    function loadPublicKeyfile(){
        var keyFile = $('#publicKeyfile')
        var formData = new FormData()
        formData.append("content", keyFile[0].files[0]);
        var xhr = new XMLHttpRequest()
        xhr.onreadystatechange = function() {
            if (xhr.readyState == XMLHttpRequest.DONE) {
                if (xhr.status == 200) {var data = JSON.parse(xhr.response)
                    var s = ""
                    for (i = 0; i < data.content.length; i++) {
                        s += String.fromCharCode(data.content[i])
                    }
                    $('#publicKey').val(s)

                }
            }
        }

        xhr.open ("POST", "/servlets/fileServlet", true)
        xhr.send (formData)
    }



    function update () {
        if ($('#name').val() == "")
            alert ("Please enter a login")


        if ($('#publicKey').val().trim() == "")
            alert("Please supply a pubic key")


        var o = new Object();
        o = {
            name: $('#name').val(),
            category: $('#type').val(),
            description: $('#description').val(),
            publicKeyPem: $('#publicKey').val()
        }

        var p = new Object()
        p = {
            user: o
        }
        var json=JSON.stringify(p)

        $.post ("/users/update", json,
        function (data, textStatus, jqxhr){
            alert(data);

            resultObject = JSON.parse(data)
            if (resultObject.result == "Success")
                window.location.href = "listUsers.html"

        })
    }


    function callLoadUser (userName) {
        var userName = getParameterByName ("name")
        var userObject = new Object();
        request = { user: userName }

        var json=JSON.stringify(request)
        $.post("/users/read", json, userLoaded)
    }

    function userLoaded (data, status, jqxhr) {
        var object = JSON.parse(data);
        if (object.result == "Success") {
            $('#name').val (object.object.name)
            $('#category').val (object.object.category)
            $('#description').val (object.object.description)
            $('#publicKey').val (object.object.publicKeyPem)
        }
    }

    function getParameterByName(name, url) {
        if (!url) url = window.location.href;
        name = name.replace(/[\[\]]/g, "\\$&");
        var regex = new RegExp("[?&]" + name + "(=([^&#]*)|&|#|$)"),
            results = regex.exec(url);
        if (!results) return null;
        if (!results[2]) return '';
        return decodeURIComponent(results[2].replace(/\+/g, " "));
    }

</script>